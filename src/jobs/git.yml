---
version: 2.1

parameters:
  github_token:
    type: env_var_name
    default: GITHUB_TOKEN
    description: |
      Token for github cli
  git_user_email:
    type: env_var_name
    default: GIT_USER_EMAIL
    description: |
      Email to use for Git
  git_user_name:
    type: env_var_name
    default: GIT_USER_NAME
    description: |
      Name to use for Git
  git_commit_message:
    type: string
    default: "Automated linting fixes by MegaLinter"
    description: |
      Commit message to use for Git
  git_pr_title:
    type: string
    default: "[MegaLinter] Apply linters automatic fixes"
    description: |
      Title to use for the pull request
  git_branch_name:
    type: string
    default: "megalinter-fixes-$CIRCLE_BUILD_NUM"
    description: |
      Branch name to use for Git
  git_base_branch:
    type: string
    default: "main"
    description: |
      Base branch to use for Git

steps:
  - run:
      environment:
        PARAM_UPD_SRC_FILES: <<parameters.working_directory>>/megalinter-reports/updated_sources
      name: Check if updated_sources folder exists
      command: <<include(scripts/check_updated_sources.sh)>>
  - run:
      environment:
        PARAM_UPD_SRC_FILES: <<parameters.working_directory>>/megalinter-reports/updated_sources
      name: Get the updated sources in megalinter-reports
      command: <<include(scripts/get_updated_sources.sh)>>
  - github-cli/setup:
      token: <<parameters.github_token>>
  - run:
      environment:
        GIT_USER_EMAIL: <<parameters.git_user_email>>
        GIT_USER_NAME: <<parameters.git_user_name>>
        GIT_COMMIT_MESSAGE: <<parameters.git_commit_message>>
        GIT_PR_TITLE: <<parameters.git_pr_title>>
        GIT_BRANCH_NAME: <<parameters.git_branch_name>>
        GIT_BASE_BRANCH: <<parameters.git_base_branch>>
      name: Set up Git
      command: <<include(scripts/setup_git.sh)>>
