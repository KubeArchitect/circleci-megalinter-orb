description: >
  Run megalinter on your project.

parameters:
  parallelism:
      type: integer
      default: 1
      description: The number of parallel jobs to run. See https://circleci.com/docs/parallelism-faster-jobs/
  executor:
      type: executor
      default: default
      description: The name of executor to use.
  version:
    type: string
    default: latest
    description: |
      Choose a specific version of megalinter:
      https://hub.docker.com/r/oxsecurity/megalinter/tags
  flavor:
    type: string
    default: ""
    description: |
      Choose a specific flavor of megalinter.
      Available flavors can be checked here:
      https://megalinter.io/latest/flavors/
  github_token:
    type: string
    default: ""
    description: |
      GitHub token to use for the reporters in megalinter
  persist_megalinter_reports:
    type: boolean
    default: false
    description: |
      If megalinter-reports folder should be persisted to other jobs. Ex. to automatically update files in your repo

environment:
  GITHUB_TOKEN=<<parameters.github_token>>
  CI_ACTION_RUN_URL=$CIRCLE_BUILD_URL
  GITHUB_REPOSITORY=$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
  GITHUB_REF=$CI_PULL_REQUEST
  GITHUB_SHA=$CIRCLE_SHA1
  DEFAULT_WORKSPACE=$CIRCLE_WORKING_DIRECTORY
  GITHUB_WORKSPACE=$CIRCLE_WORKING_DIRECTORY
  GITHUB_RUN_ID=$CIRCLE_BUILD_NUM

executor: <<parameters.executor>>
parallelism: <<parameters.parallelism>

working_directory: /tmp/lint
# https://circleci.com/docs/reusing-config/#defining-conditional-steps

steps:
  - checkout
  - run:
      name: Run Megalinter
      command: /bin/bash -ex /entrypoint.sh
  - when:
      condition: <<parameters.persist_megalinter_reports>>
      steps:
        - store_artifacts:
            path: megalinter-reports
        - persist_to_workspace:
            root: /tmp/lint
            paths:
              - megalinter-reports
            when: <<parameters.persist_megalinter_reports>>


